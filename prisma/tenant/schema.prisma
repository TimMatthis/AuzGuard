// Tenant-specific schema
// This is deployed to each tenant's database
generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client-tenant"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  password_hash     String
  role              String              @default("viewer")
  name              String?
  email_verified    Boolean             @default(false)
  verification_token String?            @unique
  verification_token_expires DateTime?
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  last_login        DateTime?
  is_active         Boolean             @default(true)
  user_group_id     String?
  userGroup         UserGroup?          @relation(fields: [user_group_id], references: [id], onDelete: SetNull)
  chatSessions      ChatSession[]

  @@map("users")
}

model UserGroup {
  id                  String               @id @default(uuid())
  name                String               @unique
  created_at          DateTime             @default(now())
  updated_at          DateTime             @updatedAt
  default_pool_id     String?
  allowed_pools       Json?
  default_policy_id   String?
  allowed_policies    Json?
  route_profile_id    String?
  routeProfile        RouteProfile?        @relation(fields: [route_profile_id], references: [id], onDelete: SetNull)
  product_access_group_id String?
  productAccessGroup  ProductAccessGroup?  @relation(fields: [product_access_group_id], references: [id], onDelete: SetNull)
  users               User[]

  @@map("user_groups")
}

model ProductAccessGroup {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  products    Json
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  userGroups  UserGroup[]

  @@map("product_access_groups")
}

model RouteProfile {
  id          String      @id @default(uuid())
  name        String      @unique
  pool_id     String?
  basic       Json?
  preferences Json
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  userGroups  UserGroup[]

  @@map("route_profiles")
}

model Policy {
  policy_id           String   @id
  version             String
  title               String
  jurisdiction        String
  evaluation_strategy Json
  rules               Json
  residency_requirement_default String?
  residency_override            String?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
  published_by        String?

  @@map("policies")
}

model AuditLog {
  id               String   @id @default(uuid())
  timestamp        DateTime @default(now())
  rule_id          String
  effect           String
  actor_id         String?
  payload_hash     String   @db.Char(64)
  prev_hash        String   @db.Char(64)
  merkle_leaf      String?  @db.Char(64)
  redacted_payload Json?

  @@map("audit_log")
}

model ModelPool {
  pool_id      String        @id
  region       String
  description  String
  tags         Json
  targets      Json
  health       Json
  routeTargets RouteTarget[]

  @@map("model_pools")
}

model RouteTarget {
  id        String    @id @default(uuid())
  pool_id   String
  provider  String
  endpoint  String
  weight    Int
  region    String
  is_active Boolean   @default(true)
  profile   Json?
  modelPool ModelPool @relation(fields: [pool_id], references: [pool_id], onDelete: Cascade)

  @@map("route_targets")
}

model ModelInvocation {
  id                 String   @id @default(uuid())
  created_at         DateTime @default(now())
  policy_id          String
  rule_id            String?
  decision           String
  model_pool         String?
  provider           String
  model_identifier   String
  latency_ms         Int
  prompt_tokens      Int?
  completion_tokens  Int?
  total_tokens       Int?
  estimated_cost_aud Float?
  audit_log_id       String?
  request_payload    Json
  response_payload   Json?
  error_message      String?

  @@index([created_at], map: "idx_model_invocation_created_at")
  @@index([policy_id], map: "idx_model_invocation_policy")
  @@map("model_invocations")
}

model TenantBranding {
  id           String   @id @default(uuid())
  company_name String
  logo_url     String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@map("tenant_branding")
}

model ChatSession {
  id          String       @id @default(uuid())
  user_id     String
  title       String?      // First message preview or custom title
  policy_id   String?
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  user        User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id            String      @id @default(uuid())
  session_id    String
  role          String      // 'user' or 'assistant'
  content       String
  created_at    DateTime    @default(now())
  session       ChatSession @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id], map: "idx_chat_message_session")
  @@map("chat_messages")
}

model ApiKey {
  id            String   @id @default(uuid())
  provider      String   // 'openai', 'gemini', 'ollama', etc.
  name          String   // Human-readable name (e.g., "OpenAI Production")
  encrypted_key String   // Encrypted API key
  models        Json?    // Array of model identifiers this key can be used for
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  last_used_at  DateTime?

  @@unique([provider, name])
  @@map("api_keys")
}

